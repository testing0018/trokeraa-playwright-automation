import { Page, Locator } from '@playwright/test';

export class MobileSettingsPage {
  readonly page: Page;

  constructor(page: Page) {
    this.page = page;
  }

  /* ================= HELPERS ================= */

  async tap(locator: Locator) {
    await locator.waitFor({ state: 'visible' });
    await locator.tap();
  }

  async type(locator: Locator, value: string) {
    await locator.waitFor({ state: 'visible' });
    await locator.fill(value);
  }

  /* ================= NAVIGATION ================= */

  async openSettings() {
    await this.tap(
      this.page.locator("//a[p[normalize-space()='Ajustes']]")
    );
  }

  async openPersonal() {
    await this.tap(
      this.page.locator("//a[contains(@href,'/personal')]")
    );
  }

  async openSecurity() {
    await this.tap(
      this.page.locator("//a[contains(@href,'/security')]")
    );
  }

  async openOverview() {
    await this.tap(
      this.page.locator("//a[.//p[normalize-space()='Resumen']]")
    );
  }

  /* ================= PERSONAL ================= */

  async selectBtcDenomination(value: string) {
    await this.page.locator('#btc_denomination').selectOption(value);
  }

  async uploadAvatar(imagePath: string) {
    await this.page
      .locator("input[type='file']")
      .setInputFiles(imagePath);
  }

  async enterCompanyName(company: string) {
    await this.type(
      this.page.locator("input[name='company_name']"),
      company
    );
  }

  async saveChanges() {
    const saveBtn = this.page.locator("input[value='Save changes']");
    await saveBtn.scrollIntoViewIfNeeded();
    await this.tap(saveBtn);
  }

  /* ================= SECURITY ================= */

  async openChangePassword() {
    await this.tap(
      this.page.locator("//a[contains(@href,'change_password')]")
    );
  }

  async enterCurrentPassword(password: string) {
    await this.type(
      this.page.locator("input[name='current_password']"),
      password
    );
  }

  async enterNewPassword(password: string) {
    await this.type(
      this.page.locator("input[name='new_password']"),
      password
    );
  }

  async enterConfirmPassword(password: string) {
    await this.type(
      this.page.locator("input[name='repeat_password']"),
      password
    );
  }

  async submitChangePassword() {
    await this.tap(
      this.page.locator("button:has-text('Enviar')")
    );
  }

  /* ================= VALIDATIONS ================= */

  async isPasswordChangeSuccess(): Promise<boolean> {
    return await this.page
      .locator("div.alert-success")
      .isVisible();
  }

  async isPasswordMismatchError(): Promise<boolean> {
    return await this.page
      .locator("#repeat_password-error")
      .isVisible();
  }
}
